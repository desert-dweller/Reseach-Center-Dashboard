{% extends "base.html" %}
{% block content %}
<style>
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
    }

    .calendar-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        text-align: center;
        margin-bottom: 10px;
    }

    .day-cell {
        min-height: 140px;
        /* Taller to fit multiple items */
        background-color: #fff;
        border: 1px solid #dee2e6;
        font-size: 0.85rem;
    }

    .day-number {
        font-weight: bold;
        padding: 5px 8px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        color: #666;
    }

    /* The mini-card for each booking */
    .booking-item {
        padding: 4px 6px;
        margin: 4px;
        border-radius: 4px;
        background-color: #e3f2fd;
        border-left: 3px solid #0d6efd;
        font-size: 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .booking-item:hover {
        background-color: #d1e7dd;
        border-left-color: #198754;
    }

    .admin-badge {
        border-left-color: #dc3545;
        background-color: #f8d7da;
    }
</style>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>Master Schedule</h2>
            <h5 class="text-muted">{{ current_month_name }} {{ year }}</h5>
        </div>
        <div class="btn-group">
            <a href="{{ url_for('admin.list_reservations', year=prev_year, month=prev_month) }}"
                class="btn btn-outline-secondary">&larr; Prev</a>
            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-dark">Dashboard</a>
            <a href="{{ url_for('admin.list_reservations', year=next_year, month=next_month) }}"
                class="btn btn-outline-secondary">Next &rarr;</a>
        </div>
    </div>

    <div class="card shadow border-0">
        <div class="card-body p-3">
            <div class="calendar-header fw-bold text-muted small text-uppercase">
                <div>Sun</div>
                <div>Mon</div>
                <div>Tue</div>
                <div>Wed</div>
                <div>Thu</div>
                <div>Fri</div>
                <div>Sat</div>
            </div>

            <div class="calendar-grid">
                {% for week in month_days %}
                {% for day in week %}
                {% if day == 0 %}
                <div class="day-cell bg-light border-0 opacity-25"></div>
                {% else %}
                <div class="day-cell shadow-sm">
                    <div class="day-number">
                        {{ day }}
                    </div>

                    <div class="d-flex flex-column p-1">
                        {% if day in reservations_by_day %}
                        {% for slot in reservations_by_day[day] %}
                        <div class="booking-item {% if slot.reserved_by_user.is_admin %}admin-badge{% endif %}"
                            title="{{ slot.reserved_by_user.email }}">
                            <div class="text-truncate" style="max-width: 85%;">
                                <strong>{{ slot.server.name }}</strong><br>
                                {{ slot.reserved_by_user.username }}
                            </div>

                            <form action="{{ url_for('admin.force_cancel_reservation', slot_id=slot.id) }}"
                                method="POST" class="ms-1">
                                <button type="submit" class="btn btn-link text-danger p-0"
                                    style="font-size: 1rem; line-height: 1;"
                                    onclick="return confirm('Revoke {{ slot.reserved_by_user.username }} from {{ slot.server.name }} on this day?');">
                                    &times;
                                </button>
                            </form>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="text-center text-muted mt-4 opacity-25 small">-</div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% endfor %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}